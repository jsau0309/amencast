// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
  // output   = "node_modules/.prisma/client" // Commented out to use default location (root node_modules)
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// From SRS ERD:
// users (managed by Clerk)
// id uuid PK
// Note: The 'users' table is managed by Clerk. listener_id in 'Stream'
// will store the Clerk user ID. For now, we won't define a 'User' model here.

model Stream {
  id               String    @id @default(uuid())
  youtube_video_id String
  status           String // e.g., "pending", "processing", "live", "ended", "error"
  listener_id      String // Clerk User ID. SRS: "listener_id uuid FK â†’ users"
  language_target  String?   // Added: e.g., "es", "en", etc.
  started_at       DateTime?
  ended_at         DateTime?

  usageEvents UsageEvent[]
  feedback    Feedback[]
  transcripts Transcript[]

  @@map("streams")
}

model UsageEvent {
  id                 BigInt   @id @default(autoincrement())
  stream_id          String
  seconds_translated Int
  created_at         DateTime @default(now())

  stream Stream @relation(fields: [stream_id], references: [id], onDelete: Cascade) // Added onDelete for referential integrity

  @@map("usage_events")
}

model Feedback {
  id         BigInt   @id @default(autoincrement())
  stream_id  String
  code       String // e.g., "AUDIO_LAG", "WRONG_VERSE", "OTHER"
  note       String?
  created_at DateTime @default(now())
  // Consider adding listener_id String? from Clerk for direct feedback ownership as discussed in plan.

  stream Stream @relation(fields: [stream_id], references: [id], onDelete: Cascade) // Added onDelete

  @@map("feedback")
}

model Transcript {
  id        BigInt @id @default(autoincrement())
  stream_id String
  start_ts  Float  @db.Real // Using Real for Float, common for timestamps
  end_ts    Float  @db.Real
  text_en   String
  text_es   String

  stream Stream @relation(fields: [stream_id], references: [id], onDelete: Cascade) // Added onDelete

  @@map("transcripts")
}

// Bible Verses Table
model BibleVerse {
  id      String  @id @default(uuid())
  book    String
  chapter Int
  verse   Int
  text_en String? @db.Text // KJV text
  text_es String  @db.Text // BLM text

  @@unique([book, chapter, verse])
  @@index([book])
  @@map("bible_verses") // Explicitly map to keep table name snake_case
}

// _prisma_migrations table will be managed by Prisma
// and does not need to be defined in the schema. 
